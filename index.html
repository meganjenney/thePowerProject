<style>
  @import url('https://fonts.googleapis.com/css2?family=PT+Sans&display=swap');

  html {
      font-family: 'PT Sans', sans-serif;
  }

  .buttons {
      cursor: pointer;
      opacity: 0;
      transition-property: opacity;
      transition-delay: 0.1s;
      transition-duration: 0.1s;
      font-size: 10pt;
  }

  .label {
      cursor: pointer;
  }

  .label:hover + .buttons, .buttons:hover {
      opacity: 1;
  }

  .buttons a {
      margin: 0.1em;
      padding: 0.1em;
      opacity: 0.5;
      transition-property: opacity;
      transition-duration: 0.1s;
      background-color: #dddddd;
      border: solid;
      border-width: 1px;
      border-color: #aaaaaa;
  }

  .buttons a:hover {
      opacity: 1;
  }

  /* draw tree structure */
  /* https://gist.github.com/dylancwood/7368914 */
  ul#tree_root, ul#tree_root ul {
      list-style: none;
      margin: 0;
      padding: 0;
  }
  ul#tree_root ul {
      margin-left: 10px;
  }
  ul#tree_root li {
      margin: 0;
      padding: 0 7px;
      line-height: 20px;
      border-left:2px solid rgb(100,100,100);

  }
  ul#tree_root li:last-child {
      border-left:none;
  }
  ul#tree_root li:before {
      position:relative;
      top:-0.3em;
      height:1em;
      width:12px;
      color:white;
      border-bottom:2px solid rgb(100,100,100);
      content:"";
      display:inline-block;
      left:-7px;
  }
  ul#tree_root li:last-child:before {
      border-left:2px solid rgb(100,100,100);
  }
</style>
<ul id="tree_root">
</ul>

<script>
  const tree_root = document.getElementById("tree_root");
  console.log(tree_root);

  request_info(function(data) {
      populate_tree(tree_root, data);
  });

  function handle_click(node_name, button_name) {
      console.log(button_name + ' was pressed on ' + node_name);
      window.prompt("message", "default response");
  }

  function create_node(name, buttons) {
      let li = document.createElement('li');
      let label_span = document.createElement('span');
      label_span.textContent = name;
      label_span.setAttribute('class', 'label');
      let buttons_span = document.createElement('span');
      buttons_span.setAttribute('class', 'buttons');
      for(const button_name of buttons) {
	  let link_elt = document.createElement('a');
	  link_elt.textContent = button_name;
	  link_elt.setAttribute('onclick', 'handle_click(\'' +
				name + '\', \'' + button_name + '\')');
	  buttons_span.appendChild(link_elt);
      }
      li.appendChild(label_span);
      li.appendChild(buttons_span);
      return li;
  }

  function populate_tree(root, data) {
      let name = data.name ? data.name : "house";
      if(data.type == "house" || data.type == "breaker") {
	  let child = create_node(name, ["new appliance", "new breaker", "delete"]);
	  let ul = document.createElement('ul');
	  child.appendChild(ul);

	  root.appendChild(child);

	  for(const child of data.children) {
	      populate_tree(ul, child);
	  }
      } else if(data.type == "appliance") {
	  let child = create_node(name, ["delete"]);

	  root.appendChild(child);
      }
  }

  function request_info(cb) {
      let xmlHttp = new XMLHttpRequest();
      xmlHttp.onload = function() {
	  cb(JSON.parse(xmlHttp.responseText));
      }
      xmlHttp.open("GET", "/info", true);
      xmlHttp.send(null);
  }
</script>
