<style>
  @import url('https://fonts.googleapis.com/css2?family=PT+Sans&display=swap');

  html {
      font-family: 'PT Sans', sans-serif;
  }

  .buttons {
      cursor: pointer;
      opacity: 0;
      transition-property: opacity;
      font-size: 10pt;
  }

  .label {
      cursor: pointer;
  }

  .label:hover + .buttons, .buttons:hover {
      opacity: 1;
  }

  .buttons a {
      margin: 0.1em;
      padding: 0.1em;
      opacity: 0.5;
      transition-property: opacity;
      background-color: #dddddd;
      border: solid;
      border-width: 1px;
      border-color: #aaaaaa;
  }

  .buttons a:hover {
      opacity: 1;
  }

  /* draw tree structure */
  /* https://gist.github.com/dylancwood/7368914 */
  ul#tree_root, ul#tree_root ul {
      list-style: none;
      margin: 0;
      padding: 0;
  }
  ul#tree_root ul {
      margin-left: 10px;
  }
  ul#tree_root li {
      margin: 0;
      padding: 0 7px;
      line-height: 20px;
      border-left:2px solid rgb(100,100,100);

  }
  ul#tree_root li:last-child {
      border-left:none;
  }
  ul#tree_root li:before {
      position:relative;
      top:-0.3em;
      height:1em;
      width:12px;
      color:white;
      border-bottom:2px solid rgb(100,100,100);
      content:"";
      display:inline-block;
      left:-7px;
  }
  ul#tree_root li:last-child:before {
      border-left:2px solid rgb(100,100,100);
  }

  .shutdown,
  .off {
      text-decoration: line-through;
      background-color: #d1585e;
  }

  .on {
      background-color: #9ae080;
  }
</style>
<ul id="tree_root">
</ul>

<script>
  const tree_root = document.getElementById("tree_root");
  console.log(tree_root);

  setInterval(function() {
      request_info(function(data) {
	  tree_root.innerHTML = "";
	  populate_tree(tree_root, data);
      });
  }, 1000);

  function request_action(url) {
      let xmlHttp = new XMLHttpRequest();
      xmlHttp.open("POST", url, true);
      xmlHttp.send(null);
  }

  function handle_click(node_name, button_name) {
      if(button_name == "new appliance") {
	  let parent = node_name;
	  let name = prompt("appliance name");
	  let power = prompt("appliance power");
	  if(!/\d+\.\d+/.test(power)) {
	      alert("Invalid float literal: " + power)
	      return;
	  }

	  let clock = "1.0";
	  request_action(`/new_appliance?parent=${parent}&name=${name}&power=${power}&clock=${clock}`);
      } else if(button_name == "new breaker") {
	  let name = prompt("breaker name");
	  let power = prompt("breaker maximum power");
	  if(!/\d+\.\d+/.test(power)) {
	      alert("Invalid float literal: " + power)
	      return;
	  }

	  request_action(`/new_breaker?name=${name}&power=${power}`);
      } else if(button_name == "delete") {
	  let name = node_name;
	  request_action(`/delete?name=${name}`);
      } else if(button_name == "turn on") {
      let name = node_name;
      request_action(`/turn_on?name=${name}`);
      } else if(button_name == "turn off") {
      let name = node_name;
      request_action(`/turn_off?name=${name}`);
      }
  }

  function create_node(data, buttons) {
      let name = data.name ? data.name : "house";
      let status = data.status ? data.status : "";
      let usage_string = data.current_usage.toString()
	  + (data.max_power ? "A / " + data.max_power.toString() : "A");

      let li = document.createElement('li');
      let label_span = document.createElement('span');
      label_span.textContent = name + ": " + usage_string;
      label_span.setAttribute('class', 'label ' + status);
      let buttons_span = document.createElement('span');
      buttons_span.setAttribute('class', 'buttons');
      for(const button_name of buttons) {
	  let link_elt = document.createElement('a');
	  link_elt.textContent = button_name;
	  link_elt.setAttribute('onclick', 'handle_click(\'' +
				name + '\', \'' + button_name + '\')');
	  buttons_span.appendChild(link_elt);
      }
      li.appendChild(label_span);
      li.appendChild(buttons_span);
      return li;
  }

  function populate_tree(root, data) {

      if(data.type == "house" || data.type == "breaker") {
	  let child = create_node(data, ["new appliance", "new breaker", "delete"]);
	  let ul = document.createElement('ul');
	  child.appendChild(ul);

	  root.appendChild(child);

	  for(const child of data.children) {
	      populate_tree(ul, child);
	  }
      } else if(data.type == "appliance") {
	  let child = create_node(data, ["turn on", "turn off", "delete"]);

	  root.appendChild(child);
      }
  }

  function request_info(cb) {
      let xmlHttp = new XMLHttpRequest();
      xmlHttp.onload = function() {
	  cb(JSON.parse(xmlHttp.responseText));
      }
      xmlHttp.open("GET", "/info", true);
      xmlHttp.send(null);
  }
</script>
